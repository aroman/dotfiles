#!/usr/bin/env sh
# Spawn a terminal as a tab in the current column in niri.
#
# Niri has no native "open window into current column" action â€” new windows
# always land in their own column. This script works around that by:
#   1. Spawning ptyxis (which niri places in a new column to the right)
#   2. Listening to niri's event stream for the window to appear
#   3. Consuming it back into the original column and switching to tabbed view

# Launch terminal in the background. Niri auto-focuses it in a new column.
ptyxis --new-window &

# Subscribe to niri's event stream and wait for our new window.
# `timeout 3` ensures we don't hang forever if something goes wrong.
timeout 3 niri msg event-stream | while IFS= read -r line; do
  case "$line" in
    # Match on both the event type AND app ID to avoid reacting to unrelated
    # window changes (e.g. title updates on other windows).
    *"Window opened or changed"*org.gnome.Ptyxis*)
      # The new terminal is focused in its own column. Pull it left into the
      # column we were in before, then switch that column to tabbed display.
      niri msg action consume-or-expel-window-left
      niri msg action set-column-display tabbed
      exit 0
      ;;
  esac
done
