#!/usr/bin/env bash
# Open a URL in the existing Figma Chrome app window via CDP,
# or launch Figma if it isn't running yet.
#
# Used as both the handlr URL handler (for https://figma.com links)
# and the desktop entry launcher (for opening Figma from the app menu).

set -euo pipefail

URL="${1:-https://www.figma.com}"
CDP_PORT=9222
CHROME="google-chrome-stable"
DATA_DIR="$HOME/.config/figma-chrome"
USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/145.0.0.0 Safari/537.36"

launch_figma() {
  exec "$CHROME" \
    --user-data-dir="$DATA_DIR" \
    --user-agent="$USER_AGENT" \
    --hide-crash-restore-bubble \
    --remote-debugging-port="$CDP_PORT" \
    --app="$URL"
}

# Connect to existing Figma instance via CDP, or launch if not running
tabs=$(curl -sf --max-time 1 "http://127.0.0.1:$CDP_PORT/json/list") || launch_figma

ws_url=$(echo "$tabs" | jq -r '
  [.[] | select(.url | test("figma\\.com"))][0]
  .webSocketDebuggerUrl // empty
')
[[ -z "$ws_url" ]] && launch_figma

# Navigation logic lives in JS so we can use the browser's URL parser and
# Figma's Plugin API directly, instead of reimplementing them in bash.
#
# If we're already on the same file, we use the Plugin API to jump to the
# target node instantly (no reload). The Plugin API (global `figma` object)
# is only available after a plugin has been opened once in the session —
# if it's missing, we fall back to a full page navigation.
url_literal=$(printf '%s' "$URL" | jq -Rs .)

IFS= read -r -d '' js <<JSEOF || true
(async () => {
  const target = new URL($url_literal);
  const current = new URL(window.location.href);
  const sameFile = target.pathname === current.pathname;
  const nodeId = target.searchParams.get('node-id')?.replace('-', ':');

  if (sameFile && nodeId && typeof figma !== 'undefined') {
    try {
      const node = await figma.getNodeByIdAsync(nodeId);
      if (node) {
        let page = node;
        while (page.parent && page.parent.type !== 'DOCUMENT') page = page.parent;
        if (page.type === 'PAGE' && page !== figma.currentPage)
          await figma.setCurrentPageAsync(page);
        figma.currentPage.selection = [node];
        figma.viewport.scrollAndZoomIntoView([node]);
        history.replaceState({}, '', target.href);
        return 'jumped';
      }
    } catch (e) {}
  }

  // Different file, no node-id, or Plugin API unavailable — full navigation
  window.location.href = target.href;
  return 'navigated';
})()
JSEOF

# Send the JS to Figma via CDP WebSocket
cdp_message=$(jq -nc --arg js "$js" '{
  id: 1,
  method: "Runtime.evaluate",
  params: {expression: $js, awaitPromise: true}
}')
echo "$cdp_message" | websocat -n1 "$ws_url" >/dev/null 2>&1

# Focus the Figma window in niri
windows=$(niri msg --json windows)
win_id=$(echo "$windows" | jq -r '
  [.[] | select(.app_id | startswith("chrome-www.figma.com"))][0]
  .id // empty
')
[[ -n "$win_id" ]] && niri msg action focus-window --id "$win_id"
